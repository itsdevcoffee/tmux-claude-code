#!/usr/bin/env bash
# Enable Claude Code indicators in tmux - Cyberpunk theme
# FIX: Use colour256 indices (not hex) to avoid # parsing issues in nested conditionals
# FIX: Use separate style tokens (not comma-separated) for reliable conditional parsing
# FIX: Use push-default/pop-default for clean style management
#
# colour256 mapping (matches hooks):
#   active:   colour54  (bg=#300B5F), colour255 (fg=#FFFFFF)
#   thinking: colour200 (bg=#F706CF), colour255 (fg=#FFFFFF)
#   question: colour128 (bg=#791E94), colour255 (fg=#FFFFFF)
#   waiting:  colour33  (bg=#035EE8), colour255 (fg=#FFFFFF)
#   complete: colour48  (bg=#02F78E), colour232 (fg=#000000)
#   ended:    colour240 (grey), colour245 (fg)
#   stale:    colour130 (amber), colour255 (fg)
#   no-claude: colour130 (bg=#8B4513), colour223 (fg=#FFE4B5)
#   current-fg: colour208 (#FF8C42)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$SCRIPT_DIR/lib/helpers.sh"

# Non-current window format - Colored backgrounds based on @claude-state
tmux set -g window-status-format '#[push-default]#{?@claude-state,#{?#{==:#{@claude-state},active},#[bg=colour54]#[fg=colour255]#[bold],#{?#{==:#{@claude-state},thinking},#[bg=colour200]#[fg=colour255]#[bold],#{?#{==:#{@claude-state},question},#[bg=colour128]#[fg=colour255]#[bold]#[blink],#{?#{==:#{@claude-state},waiting},#[bg=colour33]#[fg=colour255]#[bold]#[blink],#{?#{==:#{@claude-state},complete},#[bg=colour48]#[fg=colour232]#[bold],#{?#{==:#{@claude-state},ended},#[bg=colour240]#[fg=colour245],#{?#{==:#{@claude-state},stale},#[bg=colour130]#[fg=colour255],#[bg=colour130]#[fg=colour223]#[bold]}}}}}}},#[bg=colour130]#[fg=colour223]#[bold]} │ #I #W #{?#{==:#{@claude-state},thinking},#{@claude-thinking-frame},#{@claude-emoji}}#{@claude-count-display}#[pop-default]'

# Current window format - Arrow + colored foreground text + transparent background
tmux set -g window-status-current-format '#[push-default]#{?@claude-state,#{?#{==:#{@claude-state},active},#[bg=terminal]#[fg=colour255]#[bold],#{?#{==:#{@claude-state},thinking},#[bg=terminal]#[fg=colour200]#[bold],#{?#{==:#{@claude-state},question},#[bg=terminal]#[fg=colour128]#[bold]#[blink],#{?#{==:#{@claude-state},waiting},#[bg=terminal]#[fg=colour33]#[bold]#[blink],#{?#{==:#{@claude-state},complete},#[bg=terminal]#[fg=colour48]#[bold],#{?#{==:#{@claude-state},ended},#[bg=terminal]#[fg=colour245],#{?#{==:#{@claude-state},stale},#[bg=terminal]#[fg=colour130],#[bg=terminal]#[fg=colour208]#[bold]}}}}}}},#[bg=terminal]#[fg=colour208]#[bold]} ▶ #I #W #{?#{==:#{@claude-state},thinking},#{@claude-thinking-frame},#{@claude-emoji}}#{@claude-count-display}#[pop-default]'

# Start stale detector if not already running
STALE_DETECTOR="$SCRIPT_DIR/bin/claude-stale-detector"
if [ -x "$STALE_DETECTOR" ]; then
    STALE_PID_FILE="${CLAUDE_TMPDIR}/claude-stale-detector.pid"
    if [ -f "$STALE_PID_FILE" ]; then
        EXISTING_PID=$(head -1 "$STALE_PID_FILE" 2>/dev/null)
        if ! { [ -n "$EXISTING_PID" ] && kill -0 "$EXISTING_PID" 2>/dev/null; }; then
            nohup "$STALE_DETECTOR" > /dev/null 2>&1 &
            echo $! > "$STALE_PID_FILE"
        fi
    else
        nohup "$STALE_DETECTOR" > /dev/null 2>&1 &
        echo $! > "$STALE_PID_FILE"
    fi
fi

tmux display-message "Claude indicators enabled - Cyberpunk theme"
