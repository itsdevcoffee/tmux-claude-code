#!/usr/bin/env bash
# Aggregate per-pane Claude states into window-level display variables
# Usage: claude-aggregate-state <pane_id>
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$SCRIPT_DIR/lib/helpers.sh"

PANE="${1:-$TMUX_PANE}"
[ -z "$PANE" ] && exit 1

WINDOW=$(get_window "$PANE") || exit 1

# Superscript digits for count badge
superscript() {
    local chars=("" "¹" "²" "³" "⁴" "⁵" "⁶" "⁷" "⁸" "⁹")
    if [ "$1" -le 9 ] 2>/dev/null; then
        echo "${chars[$1]}"
    else
        echo "⁺"
    fi
}

# Read all pane states in this window
count=0
worst_priority=99
worst_state=""
worst_emoji=""
latest_timestamp=0

while IFS='|' read -r pane_id pane_state pane_emoji pane_timestamp pane_cmd; do
    [ -z "$pane_state" ] && continue

    # If the pane is running a shell, Claude has exited -- clear leftover state
    case "$pane_cmd" in
        bash|zsh|fish|sh|dash|ksh|tcsh|csh|"")
            tmux set-option -p -t "$pane_id" -u @claude-pane-state 2>/dev/null || true
            tmux set-option -p -t "$pane_id" -u @claude-pane-emoji 2>/dev/null || true
            continue
            ;;
    esac

    count=$((count + 1))

    priority=$(state_priority "$pane_state")
    if [ "$priority" -lt "$worst_priority" ]; then
        worst_priority=$priority
        worst_state="$pane_state"
        worst_emoji="$pane_emoji"
    fi

    # Track latest timestamp across all panes
    if [ -n "$pane_timestamp" ] && [ "$pane_timestamp" -eq "$pane_timestamp" ] 2>/dev/null && [ "$pane_timestamp" -gt "$latest_timestamp" ]; then
        latest_timestamp="$pane_timestamp"
    fi
done < <(tmux list-panes -t "$WINDOW" \
    -F '#{pane_id}|#{@claude-pane-state}|#{@claude-pane-emoji}|#{@claude-timestamp}|#{pane_current_command}' 2>/dev/null)

# If no Claude panes found, clear window state
if [ "$count" -eq 0 ]; then
    for opt in @claude-state @claude-emoji @claude-count @claude-count-display; do
        tmux set-window-option -t "$WINDOW" -u "$opt" 2>/dev/null || true
    done
    exit 0
fi

# Set window-level display variables
tmux set-window-option -t "$WINDOW" @claude-state "$worst_state" 2>/dev/null || true
tmux set-window-option -t "$WINDOW" @claude-count "$count" 2>/dev/null || true

if [ "$latest_timestamp" -gt 0 ] 2>/dev/null; then
    tmux set-window-option -t "$WINDOW" @claude-timestamp "$latest_timestamp" 2>/dev/null || true
fi

# For thinking state, emoji comes from @claude-thinking-frame (animated)
if [ "$worst_state" != "thinking" ]; then
    tmux set-window-option -t "$WINDOW" @claude-emoji "$worst_emoji" 2>/dev/null || true
fi

# Count badge (superscript, only when >1)
if [ "$count" -gt 1 ]; then
    tmux set-window-option -t "$WINDOW" @claude-count-display "$(superscript $count)" 2>/dev/null || true
else
    tmux set-window-option -t "$WINDOW" -u @claude-count-display 2>/dev/null || true
fi

# Handle animator lifecycle: flag the hook to start animator if needed
ANIMATOR_PID_FILE="${CLAUDE_TMPDIR}/claude-animator-${WINDOW}.pid"

if [ "$worst_state" = "thinking" ]; then
    # Only flag if no animator is already running
    if [ -f "$ANIMATOR_PID_FILE" ]; then
        EXISTING_PID=$(head -1 "$ANIMATOR_PID_FILE" 2>/dev/null)
        if [ -n "$EXISTING_PID" ] && kill -0 "$EXISTING_PID" 2>/dev/null; then
            exit 0
        fi
    fi
    tmux set-window-option -t "$WINDOW" @claude-needs-animator "on" 2>/dev/null || true
else
    tmux set-window-option -t "$WINDOW" -u @claude-needs-animator 2>/dev/null || true
fi

exit 0
