#!/usr/bin/env bash
# Clean up all Claude indicator state and background processes
# Can be used for disabling indicators or debugging

set -euo pipefail

# Determine tmpdir
TMPDIR="${TMUX_TMPDIR:-/tmp}"

# Helper: kill process from PID file and remove file
kill_pid_file() {
    local pid_file="$1"
    [ -f "$pid_file" ] || return 0
    local pid=$(cat "$pid_file" 2>/dev/null | head -1)
    [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null && kill "$pid" 2>/dev/null || true
    rm -f "$pid_file"
}

# Kill all background processes by PID files
for pid_file in "${TMPDIR}"/claude-{animator,timer,flash}-*.pid; do
    [ -e "$pid_file" ] || continue
    kill_pid_file "$pid_file"
done

# Kill stale detector (global process)
kill_pid_file "${TMPDIR}/claude-stale-detector.pid"

# Kill any orphaned animator/detector processes (fallback)
# More specific pattern to avoid killing unrelated processes
pkill -f "bin/claude-thinking-animator" 2>/dev/null || true
pkill -f "bin/claude-stale-detector" 2>/dev/null || true

# Clear tmux state for all windows and panes in current session
if [ -n "${TMUX:-}" ]; then
    # Clean up pane-level options for all panes
    for pane_id in $(tmux list-panes -a -F "#{pane_id}" 2>/dev/null); do
        tmux set-option -p -t "$pane_id" -u @claude-pane-state 2>/dev/null || true
        tmux set-option -p -t "$pane_id" -u @claude-pane-emoji 2>/dev/null || true
        tmux set-option -p -t "$pane_id" -u @claude-timestamp 2>/dev/null || true
    done

    # Clean up window-level options for all windows
    for win_id in $(tmux list-windows -F "#{window_id}" 2>/dev/null); do
        tmux set-window-option -t "$win_id" -u @claude-state 2>/dev/null || true
        tmux set-window-option -t "$win_id" -u @claude-emoji 2>/dev/null || true
        tmux set-window-option -t "$win_id" -u @claude-thinking-frame 2>/dev/null || true
        tmux set-window-option -t "$win_id" -u @claude-timestamp 2>/dev/null || true
        tmux set-window-option -t "$win_id" -u @claude-count 2>/dev/null || true
        tmux set-window-option -t "$win_id" -u @claude-count-display 2>/dev/null || true
        tmux set-window-option -t "$win_id" -u @claude-needs-animator 2>/dev/null || true
        tmux set-window-option -t "$win_id" -u window-status-style 2>/dev/null || true
    done

    tmux display-message "Claude indicators cleaned up"
else
    echo "All Claude indicator processes and PID files cleaned up"
fi

exit 0
