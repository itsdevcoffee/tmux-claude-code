#!/usr/bin/env bash
# Clean up all Claude indicator state and background processes
# Can be used for disabling indicators or debugging

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$SCRIPT_DIR/lib/helpers.sh"

# Kill all background processes by PID files
for pid_file in "${CLAUDE_TMPDIR}"/claude-{animator,timer,flash}-*.pid; do
    [ -e "$pid_file" ] || continue
    kill_pid_file "$pid_file"
done
kill_pid_file "${CLAUDE_TMPDIR}/claude-stale-detector.pid"

# Kill any orphaned processes (fallback)
pkill -f "bin/claude-thinking-animator" 2>/dev/null || true
pkill -f "bin/claude-stale-detector" 2>/dev/null || true

# Clear tmux state for all windows and panes
if [ -n "${TMUX:-}" ]; then
    PANE_OPTS=(@claude-pane-state @claude-pane-emoji @claude-timestamp)
    for pane_id in $(tmux list-panes -a -F "#{pane_id}" 2>/dev/null); do
        for opt in "${PANE_OPTS[@]}"; do
            tmux set-option -p -t "$pane_id" -u "$opt" 2>/dev/null || true
        done
    done

    WINDOW_OPTS=(@claude-state @claude-emoji @claude-thinking-frame @claude-timestamp
                 @claude-count @claude-count-display @claude-needs-animator)
    for win_id in $(tmux list-windows -F "#{window_id}" 2>/dev/null); do
        for opt in "${WINDOW_OPTS[@]}"; do
            tmux set-window-option -t "$win_id" -u "$opt" 2>/dev/null || true
        done
        tmux set-window-option -t "$win_id" -u window-status-style 2>/dev/null || true
    done

    tmux display-message "Claude indicators cleaned up"
else
    echo "All Claude indicator processes and PID files cleaned up"
fi

exit 0
